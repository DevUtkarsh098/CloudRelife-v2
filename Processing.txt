import boto3
import os
import csv
import io
import math
from datetime import datetime
from decimal import Decimal
import random

# AWS clients
dynamodb = boto3.resource('dynamodb')
s3 = boto3.client('s3')

# Environment variables
PREPROCESSED_TABLE = os.environ['PREPROCESSED_TABLE']
PROCESSED_TABLE = os.environ['PROCESSED_TABLE']
REFERENCE_BUCKET = os.environ['REFERENCE_BUCKET']

RESOURCE_FILES = [
    'ambulances.csv',
    'food.csv',
    'hospitals.csv',
    'response_units.csv',
    'shelters.csv'
]


def to_decimal(value):
    try:
        return Decimal(str(round(float(value), 6)))
    except Exception:
        return Decimal("0")


def haversine(lat1, lon1, lat2, lon2):
    """Calculate distance between two lat/lon points in km"""
    R = 6371
    d_lat = math.radians(float(lat2) - float(lat1))
    d_lon = math.radians(float(lon2) - float(lon1))
    a = (
        math.sin(d_lat / 2) ** 2
        + math.cos(math.radians(float(lat1)))
        * math.cos(math.radians(float(lat2)))
        * math.sin(d_lon / 2) ** 2
    )
    return R * 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))


def read_csv_from_s3(filename):
    obj = s3.get_object(Bucket=REFERENCE_BUCKET, Key=filename)
    data = obj['Body'].read().decode('utf-8')
    reader = csv.DictReader(io.StringIO(data))
    return [row for row in reader]


def get_latest_event():
    table = dynamodb.Table(PREPROCESSED_TABLE)
    response = table.scan()
    items = response.get('Items', [])
    if not items:
        return None
    # Pick the most recent by timestamp
    items.sort(key=lambda x: x.get('timestamp', ''), reverse=True)
    return items[0]


def convert_floats_to_decimals(obj):
    if isinstance(obj, list):
        return [convert_floats_to_decimals(i) for i in obj]
    elif isinstance(obj, dict):
        return {k: convert_floats_to_decimals(v) for k, v in obj.items()}
    elif isinstance(obj, float):
        return Decimal(str(round(obj, 6)))
    else:
        return obj


def lambda_handler(event, context):
    latest_event = get_latest_event()
    if not latest_event:
        return {"status": "No events found in PreprocessedTable"}

    event_lat = float(str(latest_event['latitude']).strip())
    event_lon = float(str(latest_event['longitude']).strip())
    incident_id = latest_event['event_id']

    record = {
        "incident_id": incident_id,
        "enriched_clean_description": latest_event.get("clean_description", ""),
        "enriched_disaster_risk_index": to_decimal(latest_event.get("disaster_risk_index", 0)),
        "enriched_est_people_affected": to_decimal(latest_event.get("est_people_affected", 0)),
        "enriched_population_density": to_decimal(latest_event.get("population_density", 0)),
        "enriched_severity_score_1_5": to_decimal(latest_event.get("severity_score_1_5", 0)),
        "enriched_urgency_score": to_decimal(latest_event.get("urgency_score", 0)),
        "state": latest_event.get("state", ""),
        "status": "PROCESSED",
        "timestamp": datetime.utcnow().isoformat()
    }

    for file in RESOURCE_FILES:
        resource_name = file.replace(".csv", "")
        resources = read_csv_from_s3(file)
        nearby = []

        for r in resources:
            try:
                lat_key = "lat" if "lat" in r else "latitude"
                lon_key = "lon" if "lon" in r else "longitude"

                # Force resource_id to string
                resource_id = str(r.get("resource_id") or r.get("id") or r.get("unit_name") or "UNKNOWN")

                r_lat = float(str(r.get(lat_key, 0)).strip())
                r_lon = float(str(r.get(lon_key, 0)).strip())

                dist = haversine(event_lat, event_lon, r_lat, r_lon)
                # For testing/demo: replace zero distance with random value
                if dist == 0:
                    dist = round(random.uniform(1, 500), 2)

                nearby.append({
                    "resource_id": resource_id,
                    "location": str(r.get("location") or r.get("state") or "Unknown"),
                    "distance_km": round(dist, 2)
                })
            except Exception as e:
                print(f"Error processing {file} row: {e}")
                continue

        nearby.sort(key=lambda x: x["distance_km"])
        top3 = nearby[:3]

        for idx, res in enumerate(top3):
            record[f"nearest_resources_{resource_name}_{idx}_distance_km"] = to_decimal(res["distance_km"])
            record[f"nearest_resources_{resource_name}_{idx}_location"] = res["location"]
            record[f"nearest_resources_{resource_name}_{idx}_resource_id"] = res["resource_id"]

    # Save to ProcessedIncidentsTable
    processed_table = dynamodb.Table(PROCESSED_TABLE)
    processed_table.put_item(Item=convert_floats_to_decimals(record))

    return {
        "status": "Processed and saved successfully",
        "incident_id": incident_id,
        "record_keys": list(record.keys())
    }
